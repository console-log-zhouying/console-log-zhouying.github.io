---
title: V8引擎的垃圾回收
categories: JS性能优化
tags: 垃圾回收
---

#### 一、介绍

- V8是一款主流的JavaScript执行引擎，chromd以及nodejs平台都在使用
- V8采用即时编译
- V8内存设限。64位操作系统不超过1.5G，32位操作系统不超过800M。
  - 因为V8本身就是为了浏览器制造的，这个内存大小对网页应用来说足够了
  - 内部的垃圾回收机制决定这种内存是合理的

<!-- more -->

#### 二、V8垃圾回收策略

- 采用分代回收的思想
- 内存分为新生代、老生代
- 针对不同对象采用不同GC算法


#### 三、V8中常用的GC算法

- 分代回收
- 空间复制
- 标记清除
- 标记整理
- 标记增量


#### 四、V8如何回收新生代对象

1. ##### 新生代对象介绍

   - V8内存空间一分为二。一部分小的内存空间，一部分大的内存空间
   - 小空间用于存储新生代对象（32M ｜16M）
   - 新生代指的是存活时间较短的对象。比如局部作用域里的变量在执行完一段代码后就会被回收，全局的变量会在程序退出之后就会被回收。相对来说，新声代指的是存活时间较短的对象

2. ##### 回收过程

   - 回收过程采用复制算法+标记整理
   - 新生代内存区分为两个等大小空间
   - 使用空间为From，空间空间为To
   - 活动对象存储于From空间
   - 标记整理后将活动对象拷贝至To
   - From于To交换空间完成释放

3. ##### 回收细节说明

   - 拷贝过程中可能出现晋升。晋升就是将新生代对象移动至老生代
   - 一轮GC还存活的新生代需要晋升
   - To空间的使用率超过25%。（因为最后To和From需要交换空间，80%以上的话新的对象也增加不进来了）


#### 五、V8如何回收老生代对象

1. ##### 老生代对象说明

   - 老生代对象存放在右侧老生代区域
   - 64位操作系统1.4G，32位操作系统700M
   - 老生代对象就是指存活时间较长的对象

2. ##### 老生代对象回收实现

   - 主要采用标记清除、标记整理、增量标记算法

   - 首先使用标记清除算法完成垃圾空间的回收。（V8底层用的大部分还是标记清除算法，虽然会导致碎片化空间，但是速度很快）

   - 若新生代对象要往老生代对象移动时，但老生代的空间又不足以存放新生代的对象时，会采用标记整理进行空间优化

   - 最后采用增量标记进行效率优化

     ![5-1](5-1.png)

     - 在程序执行的间隙进行标记和清除，时间分配更合理，因为垃圾回收时程序是不能运行的。


#### 六、二者细节对比

- 新生代区域垃圾回收使用空间换时间。
  - 因为采用复制算法，每时每刻内部都有一个空闲空间的存在。本身空间很小，所以分出来的空间更小。空间的浪费相对于带来的时间上的提升是微不足道的
- 老生代区域垃圾回收不适合复制算法。
  - 因为空间很大，如果一分为二，就有几百兆的空间浪费不用
  - 老生代内存放的对象比较多，所以复制所需要的时间也很多